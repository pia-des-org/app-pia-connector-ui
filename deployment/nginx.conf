events {}
http {
  include /etc/nginx/mime.types;

  # HTTP server - redirects to HTTPS
  server {
      listen       80;
      server_name  localhost;

      # Redirect all HTTP requests to HTTPS
      return 301 https://$host$request_uri;
  }

  # HTTPS server with mTLS
  server {
      listen       443 ssl;
      server_name  localhost;

      # SSL configuration
      # Server certificate and key
      ssl_certificate     /etc/nginx/ssl/server.crt;
      ssl_certificate_key /etc/nginx/ssl/server.key;
      # If your key is encrypted, provide the passphrase file (uncomment and point to the file):
      # ssl_password_file   /etc/nginx/ssl/server.key.pass;

      # mTLS configuration
      # Using combined certificate file (root + intermediate) for client verification
      ssl_client_certificate /etc/nginx/ssl/fnmt-combined.pem;
      ssl_verify_client optional;

      root   /usr/share/nginx/html;
      index  index.html;

      location / {
          try_files $uri $uri/ /index.html;
      }

      # Endpoint to expose certificate information to the frontend
      location /me {
          add_header X-Client-CN $ssl_client_s_dn;
          add_header Access-Control-Expose-Headers "X-Client-CN";
          return 200 "OK";
      }
  }
}
